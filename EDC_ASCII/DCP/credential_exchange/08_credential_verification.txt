8. Credential Verification (Verificación de Credenciales)

   VERIFIER (CONTROL PLANE)                          HOLDER (IDENTITY HUB)
   +-----------------------+                        +-----------------------+
   | Control Plane         |                        | Identity Hub          |
   |                       |  (1) Presentation      |                       |
   | [Identity Service]    |      Query             | [Presentation API]    |
   | (Prepara solicitud)   | ---------------------> | (Valida token acceso) |
   |                       |   POST /query          |                       |
   |                       |   (Scopes requeridos)  |  (2) Resolution       |
   |                       |                        | [CredentialQuery      |
   |                       |                        |  Resolver]            |
   |                       |  (3) VP Response       | (Selecciona VCs)      |
   |                       | <--------------------- | [VP Service]          |
   |                       |   (VP Token JWT)       | (Genera y firma VP)   |
   +-----------------------+                        +-----------------------+
          |
          | (4) Verificación Local
          v
   +-----------------------+
   | [Token Verifier]      |
   | (Valida firma VP)     |
   |        |              |
   |        v              |
   | [DID Resolver]        |
   | (Resuelve DID Holder) |
   | (Obtiene clave pública)|
   |        |              |
   |        v              |
   | [Signature Validator] |
   | (Verifica firma JWT)  |
   |        |              |
   |        v              |
   | [VC Extractor]        |
   | (Extrae VCs del VP)   |
   +-----------------------+
          |
          | (5) Para cada VC en el VP
          v
   +-----------------------+                        +-----------------------+
   | [VC Validator]        |                        | ISSUER (STATUS HOST)  |
   |                       |  (6) Fetch Status      |                       |
   | [Issuer DID Resolver] | ---------------------> | [Status Endpoint]     |
   | (Resuelve DID Issuer) |   GET /statuslist/N    | (Servidor estático)   |
   |                       |                        |                       |
   |                       |  (7) StatusList VC     |                       |
   | [Signature Validator] | <--------------------- |                       |
   | (Verifica firma VC)   |   (Signed BitString)   |                       |
   |                       |                        |                       |
   | [Revocation Checker]  |                        |                       |
   | (Verifica bit en      |                        |                       |
   |  índice especificado) |                        |                       |
   +-----------------------+                        +-----------------------+
          |
          | (8) Resultado Final
          v
   +-----------------------+
   | [Policy Engine]       |
   | (Evalúa claims vs     |
   |  Access Policy)       |
   | (Decisión: ALLOW/DENY)|
   +-----------------------+


Descripción Técnica:

Este diagrama detalla el flujo completo de verificación desde la perspectiva del Verificador (típicamente un Control Plane que necesita validar las credenciales de una contraparte antes de autorizar acceso a datos o negociar un contrato).

(1) Presentation Query: El Verificador envía un PresentationQueryMessage al Identity Hub del Holder. El mensaje incluye los scopes o tipos de credenciales requeridos (ej. "MembershipCredential", "AuditCertificationCredential"). EDC actualmente utiliza scopes simples; el soporte completo de DIF Presentation Exchange está en desarrollo.

(2) Resolution: El Identity Hub del Holder utiliza el CredentialQueryResolver para buscar credenciales en su almacenamiento local que coincidan con los scopes solicitados.

(3) VP Response: El VerifiablePresentationService del Holder empaqueta las credenciales seleccionadas en una Verifiable Presentation (VP). La VP se firma con la clave privada del Holder y se retorna en formato JWT.

(4) Verificación Local - Firma del VP:
   • Token Verifier: Extrae el JWT y verifica su estructura
   • DID Resolver: Resuelve el DID del Holder (ej. did:web:holder.example) para obtener su DID Document
   • Signature Validator: Usa la clave pública del DID Document para verificar la firma del JWT. Si falla, el proceso se detiene con error de autenticación.

(5) Iteración sobre VCs: El VP puede contener múltiples Verifiable Credentials. Cada una debe validarse individualmente.

(6-7) Validación de cada VC:
   • Issuer DID Resolver: Resuelve el DID del Issuer de la credencial
   • Signature Validator: Verifica que la VC fue firmada por el Issuer declarado
   • Revocation Checker: Si la VC tiene un campo credentialStatus, el Verificador descarga la lista de revocación (BitStringStatusList o StatusList2021) y verifica que el bit correspondiente al índice de la credencial sea 0 (válido)

(8) Policy Evaluation: Una vez validadas todas las credenciales criptográficamente:
   • El Policy Engine evalúa si los claims contenidos en las VCs satisfacen la Access Policy o Contract Policy definida
   • Ejemplo: La política requiere "membershipLevel >= Gold" y la VC contiene "membershipLevel: Platinum" → ALLOW
   • El resultado determina si se autoriza la operación (negociación de contrato, acceso a catálogo, etc.)

Formatos Soportados:
- VC1_0_JWT: Verifiable Credentials Data Model 1.0 en formato JWT (principal)
- VC2_0: Soporte experimental para Data Model 2.0

Estándares Aplicados:
- W3C Verifiable Credentials Data Model 1.1
- W3C Decentralized Identifiers (DIDs) - método did:web
- W3C Bitstring Status List (para revocación)
